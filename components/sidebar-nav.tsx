"use client"

import Link from "next/link"
import { usePathname } from "next/navigation"
import {
  BookOpen, ShoppingCart, Package, BarChart3, Book, Candy, Users,
  DollarSign, LogOut, Shield, User, Bookmark, Tag, Menu, X, ChevronDown, ChevronRight
} from "lucide-react"
import { logout } from "@/actions/logout"
import { useSession } from "next-auth/react"
import { useState } from "react"
import { Button } from "./ui/button"

// Agrupación de rutas
const menuGroups = [
  {
    title: "Principal",
    items: [
      { href: "/", title: "Punto de Venta", icon: ShoppingCart, permission: "POS" },
      { href: "/dashboard", title: "Panel de Control", icon: BarChart3, permission: "DASHBOARD" },
      { href: "/busquedas", title: "Búsquedas Pendientes", icon: Book, permission: "PENDING" },
    ]
  },
  {
    title: "Inventario",
    items: [
      { href: "/inventario", title: "Libros", icon: Package, permission: "INVENTORY" },
      { href: "/consignaciones", title: "Consignaciones", icon: Tag, permission: "INVENTORY" },
      { href: "/dulceria", title: "Dulcería", icon: Candy, permission: "CANDY" },
      { href: "/apartados", title: "Apartados", icon: Bookmark, permission: "APARTADOS" },
    ]
  },
  {
    title: "Gestión",
    items: [
      { href: "/clientes", title: "Clientes", icon: Users, permission: "CLIENTS" },
      { href: "/gastos", title: "Gastos", icon: DollarSign, permission: "EXPENSES" },
      { href: "/admin/cortes", title: "Cortes de Caja", icon: BarChart3, permission: "CASH_CUTS" },
      { href: "/admin", title: "Admin", icon: Shield, permission: "ADMIN" },
      { href: "/perfil", title: "Perfil", icon: User, permission: "PROFILE" }, // Permission PROFILE is just a placeholder, public
    ]
  }
]

export function SidebarNav() {
  const pathname = usePathname();
  const { data: session, status } = useSession();
  const user = session?.user;
  const [isOpen, setIsOpen] = useState(false); // Mobile state
  const [expandedGroups, setExpandedGroups] = useState<Record<string, boolean>>({
    Principal: true,
    Inventario: true,
    Gestión: true
  });

  // Force re-render when session changes
  if (status === "loading") return <div className="w-64 bg-white border-r border-slate-200 hidden md:block" />;

  const isAdmin = user?.role === 'ADMIN';
  const permissions = user?.permissions || [];
  const userName = user?.name || "Usuario";
  const userRole = user?.role || "Rol";
  const userInitial = userName[0] || "U";

  const toggleGroup = (group: string) => {
    setExpandedGroups(prev => ({ ...prev, [group]: !prev[group] }));
  }

  // Mobile overlay click handler
  const closeMobileMenu = () => setIsOpen(false);

  const NavContent = () => (
    <div className="flex flex-col h-full bg-white border-r border-slate-200">
      <div className="flex items-center justify-between p-6 border-b border-slate-100 bg-slate-50/50">
        <div className="flex flex-col items-center gap-3 text-blue-600">
          <svg xmlns="http://www.w3.org/2000/svg" className="w-24 h-24" viewBox="0 0 639 483" fill="none">
            <path fillRule="evenodd" clipRule="evenodd" d="M403.03 294.748C415.125 294.624 431.055 293.097 436.781 301.239C442.031 308.702 442.704 325.356 436.22 332.607C425.646 344.43 404.499 329.305 402.797 314.11C402.392 310.499 402.28 297.982 403.03 294.748ZM380.014 293.759C380.157 293.874 380.405 293.823 380.486 294.047L383.888 295.512C385.433 296.281 386.048 296.868 386.754 298.846C388.194 302.881 387.552 329.25 387.552 334.547C387.552 347.185 388.905 371.685 387.172 382.703L402.7 384.924L402.687 320.692C405.982 324.563 406.383 329.78 418.124 336.849C433.979 346.396 450.884 347.927 448.745 369.689C447.325 384.123 440.88 384.735 436.185 388.644C446.476 389.614 451.791 389.396 458.241 383.811C463.056 379.642 465.538 369.968 463.19 361.254C458.608 344.246 438.934 343.739 428.842 338.24C465.232 333.894 457.862 305.252 448.431 298.44C440.432 292.663 428.028 293.229 417.014 293.233C410.445 293.235 383.833 292.158 380.014 293.759Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M557.69 293.759C562.314 298.298 565.314 289.409 565.315 314.153C565.315 323.766 566.046 379.142 564.624 384.507C563.55 388.559 561.636 389.008 559.013 389.77L556.2 390.971C560.177 392.893 575.657 390.705 580.869 390.177C579.181 383.316 580.379 346.017 580.461 336.22C588.081 336.253 597.733 336.032 604.19 338.906C612.97 342.813 613.277 350.133 616.383 351.881L616.576 319.565C613.746 320.901 614.016 328.924 604.595 332.638C597.834 335.304 588.245 334.9 580.428 334.935C580.494 327.337 579.477 299.947 580.883 294.732C601.276 294.764 614.371 292.72 629.11 304.584C632.861 307.604 634.775 311.226 637.404 314.05C637.512 314.166 637.677 314.322 637.778 314.424L638.584 315.137C638.642 314.972 638.691 314.533 638.699 314.626L638.849 313.592C638.852 313.446 638.861 313.226 638.856 313.061L635.067 293.283C626.023 293.316 560.182 292.383 557.69 293.759Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M318.928 371.2L331.196 373.498C341.631 329.791 287.417 339.188 272.406 323.749C265.125 316.26 268.635 296.291 292.232 294.819C307.953 293.838 318.38 303.208 321.233 317.793C321.348 318.379 321.452 318.981 321.616 319.551C321.674 319.755 321.746 319.949 321.805 320.131L328.669 300.941C312.365 295.368 302.482 290.637 281.406 294.551C266.902 297.244 252.952 305.8 255.824 323.405C260.893 354.481 320.11 342.748 318.928 371.2Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M471.648 390.971C474.667 392.494 539.609 391.477 549.074 391.457C549.93 387.378 553.847 372.186 552.632 369.915C551.217 369.491 547.402 376.026 543.726 379.325C540.294 382.405 536.867 384.959 531.602 386.945C525.068 389.41 500.979 391.609 494.382 389.452C494.292 382.432 493.299 304.319 495.319 299.142C496.943 294.981 499.111 295.586 501.15 294.85C503.258 294.089 502.408 294.748 503.567 293.369C492.061 293.887 481.572 293.994 470.049 293.344C472.378 295.841 476.205 294.24 478.264 299.334C480.138 303.975 479.223 360.787 479.224 369.898C479.224 379.558 480.957 387.11 474.379 389.661L471.648 390.971Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M6.00029 297.834C6.04402 297.866 7.61484 297.915 7.63184 307.337L7.62536 343.385C7.6286 352.257 9.15611 383.494 5.54403 388.347L22.9393 384.066C22.8737 367.086 21.6571 314.029 23.0004 300.895C24.0372 293.678 27.974 296.363 30.4124 293.372C19.5312 294.043 10.7577 293.705 0 293.489C0.869619 294.262 0.334001 293.897 1.60078 294.516C5.46589 296.403 4.11774 294.461 6.00029 297.834Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M47.1903 377.644C47.8279 376.995 48.2967 377.365 48.5704 374.015C49.2008 366.315 48.1813 317.98 48.519 306.303C51.0072 309.033 80.8629 363.37 84.2297 369.105L99.4715 366.018L58.8876 293.291L42.0312 293.261C44.0604 301.086 47.2627 298.235 47.204 310.067L47.1903 377.644Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M152.495 356.867L167.931 355.471C163.598 346.407 159.383 335.64 155.324 326.268C153.193 321.348 151.019 316.571 148.912 311.58C147.044 307.156 142.811 299.831 148.041 296.127C153.272 292.423 159.792 297.732 162.331 300.94C174.678 316.549 170.11 341.256 189.117 335.309L182.359 352.18C181.181 356.131 181.869 354.037 182.492 354.941C184.417 352.317 187.713 342.915 189.194 339.191C191.386 333.676 193.414 328.698 195.621 323.172C198.031 317.134 203.834 299.573 208.315 296.416L212.269 293.458L190.698 293.674C192.279 295.008 195.57 294.949 197.917 296.028C205.696 299.606 200.268 307.771 197.078 315.773C194.34 322.64 190.042 341.734 179.035 333.242C172.134 327.916 171.256 302.315 157.958 295.125C152.7 292.282 142.291 294.094 134.087 293.927L121.56 294.636L123.511 296.185C124.712 297.189 125.645 298.281 126.394 299.379C127.722 301.323 129.423 304.873 130.567 307.463C134.512 316.384 149.999 353.784 152.495 356.867Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M348.012 308.714L348.055 376.636L363.143 379.123L363.138 306.675C363.144 295.845 364.264 297.007 368.853 294.732C369.015 294.652 369.192 294.568 369.347 294.48L370.295 293.803C370.418 293.718 370.628 293.563 370.764 293.413L340.417 293.762C344.643 297.424 348.012 291.946 348.012 308.714Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M224.226 355.699L239.372 357.475L239.408 303.938C239.774 293.226 244.315 296.58 247.099 293.625C242.722 293.235 236.926 293.933 232.259 293.935C226.901 293.937 221.948 293.641 216.621 293.375C219.545 297.036 223.831 293.308 224.236 303.241C224.469 308.95 224.243 315.184 224.243 320.952C224.243 332.526 224.322 344.128 224.226 355.699Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M297.249 264.527C292.922 288.448 267.354 278.887 272.787 251.828C277.211 229.788 302.203 237.146 297.249 264.527ZM279.085 237.627C254.035 244.456 260.586 286.604 290.818 279.487C316.413 273.462 308.858 229.511 279.085 237.627Z" fill="#08A5AA" />
            <path fillRule="evenodd" clipRule="evenodd" d="M540.758 240.273C557.261 230.313 564.981 269.325 550.063 276.854C533.23 285.348 524.553 250.053 540.758 240.273ZM538.93 237.759C513.188 245.776 522.049 286.853 551.224 279.416C561.74 276.736 568.684 266.246 565.829 252.851C563.475 241.808 552.244 233.611 538.93 237.759Z" fill="#08A5AA" />
            <path fillRule="evenodd" clipRule="evenodd" d="M466.115 276.856C466.186 273.456 465.779 270.005 465.826 266.545C465.907 260.713 467.322 261.679 468.024 258.58L455.431 258.44C456.214 260.906 457.121 259.59 458.102 262.864C458.723 264.939 458.615 267.809 458.554 270.002C458.4 275.51 457.013 278.237 451.115 278.057C434.139 277.539 433.273 245.514 446.775 239.867C458.968 234.767 462.4 249.204 465.194 250.033L465.423 240.079C449.382 231.611 429.221 239.155 429.074 258.4C428.917 279.161 448.732 284.313 466.115 276.856Z" fill="#08A5AA" />
            <path fillRule="evenodd" clipRule="evenodd" d="M379.616 279.281L409.306 279.432L409.482 268.932C407.18 269.885 407.078 274.417 402.479 276.507C398.362 278.377 393.221 277.617 390.09 275.864L389.591 259.067C401.469 259.161 398.445 262.034 401.946 264.476L402.237 252.027C396.898 254.462 402.077 257.138 389.657 257.137L389.611 239.826C393.208 239.683 398.079 239.728 401.183 240.756C405.361 242.138 404.92 245.587 408.21 246.957L408.268 237.598L379.742 237.473C380.185 240.673 381.716 240.348 381.691 246.842C381.678 250.699 381.674 254.551 381.675 258.409C381.677 262.266 381.703 266.119 381.712 269.975C381.728 276.905 380.794 275.188 379.616 279.281Z" fill="#08A5AA" />
            <path fillRule="evenodd" clipRule="evenodd" d="M74.917 279.23L104.586 279.429L104.686 268.994C101.376 270.294 103.042 278.348 89.7394 277.455C85.5544 277.173 84.6715 275.323 84.5391 271.353C84.4152 267.632 84.4192 262.883 84.6383 259.181C95.6923 258.274 94.3555 262.589 97.2522 264.523L97.4838 251.607C94.1875 253.592 95.3591 258.186 84.5974 256.928L84.569 239.759C102.308 238.405 97.9992 244.372 103.557 247.09L103.551 237.525L75.0579 237.485C75.3113 241.274 77.0202 237.688 76.9813 246.841L76.9943 269.977C77.0299 276.36 76.2599 275.057 74.917 279.23Z" fill="#08A5AA" />
            <path fillRule="evenodd" clipRule="evenodd" d="M243.873 267.705C241.816 268.649 242.429 269.057 240.95 271.848C238.093 277.237 232.409 279.531 226.282 277.227C212.803 272.158 213.16 243.353 226.847 239.438C232.803 237.734 238.026 240.831 240.807 245.814C241.315 246.725 241.563 247.53 241.891 248.145C243.294 250.774 241.827 249.363 243.751 250.279L243.904 240.049C225.647 231.957 205.244 240.272 208.298 262.461C210.394 277.687 225.062 282.386 238.611 279.2C245.769 277.517 244.065 275.266 243.873 267.705Z" fill="#08A5AA" />
            <path fillRule="evenodd" clipRule="evenodd" d="M126.117 279.252L156.212 279.411C156.437 275.452 157.031 269.503 155.634 266.878C153.423 270.313 153.34 273.92 149.726 275.977C146.236 277.964 140.109 278.196 137.004 276.084C135.275 274.083 135.936 251.64 136.032 246.151C136.128 240.652 137.811 240.068 137.955 237.611L126.135 237.47C126.856 242.849 128.355 235.171 128.371 258.408C128.373 262.266 128.42 266.142 128.409 269.995C128.389 276.49 127.042 275.671 126.117 279.252Z" fill="#08A5AA" />
            <path fillRule="evenodd" clipRule="evenodd" d="M329.143 279.323L358.767 279.396C359.02 276.144 359.614 269.23 358.384 266.893C355.756 269.124 356.929 274.049 350.795 276.6C335.158 283.105 338.587 266.475 338.588 254.33C338.589 245.948 337.864 244.541 340.663 237.909L328.816 237.648C332.124 247.438 331.024 245.279 331.023 258.409C331.022 262.259 331.081 266.149 331.023 269.992C330.937 275.579 329.416 276.218 329.143 279.323Z" fill="#08A5AA" />
            <path fillRule="evenodd" clipRule="evenodd" d="M291.775 442.453L300.222 442.595C297.038 436.618 298.662 423.444 298.559 415.438C308.331 413.928 310.581 424.782 302.412 428.279C301.572 428.639 301.746 428.48 300.983 428.89C299.973 429.433 300.349 429.16 299.774 429.721C309.239 446.54 318.198 444.222 315.75 440.869L305.467 429.538C307.984 427.929 310.267 427.964 311.905 425.506C313.804 422.655 313.225 418.485 311.027 416.439C307.134 412.816 298.18 413.277 291.998 413.804C293.877 422.355 293.458 415.599 293.434 427.681C293.422 434.047 294.208 437.692 291.775 442.453Z" fill="#ECC468" />
            <path fillRule="evenodd" clipRule="evenodd" d="M268.963 440.632C267.868 437.459 268.2 432.312 268.37 428.444C273.582 428.312 277.865 429.642 277.814 435.114C277.761 440.835 273.662 441.877 268.963 440.632ZM268.309 415.176C273.574 415.051 276.697 415.96 276.368 421.465C276.099 425.958 273.031 426.929 268.285 427.049L268.309 415.176ZM261.522 442.612C268.905 442.778 286.379 444.333 283.286 432.635C282.496 429.65 280.176 428.831 277.08 427.889C278.861 426.138 281.199 425.587 281.903 422.72C282.74 419.314 281.178 416.718 279.307 415.429C275.262 412.641 267.433 413.585 261.843 413.72C262.217 418.062 263.042 414.235 263.032 427.681C263.027 434.31 263.736 437.193 261.522 442.612Z" fill="#ECC468" />
            <path fillRule="evenodd" clipRule="evenodd" d="M351.662 442.539L360.138 442.548C356.795 438.073 358.419 422.155 358.424 415.236C370.139 414.924 370.218 426.634 359.551 428.985C360.727 432.562 363.518 435.327 365.674 438.08C367.939 440.97 369.912 444.037 375.932 442.42C375.833 440.487 372.32 437.709 370.976 436.196C368.805 433.75 367.538 431.917 365.324 429.687C367.621 427.772 370.029 427.97 371.735 425.371C373.575 422.566 372.891 418.378 370.986 416.478C367.503 413.004 357.984 413.342 351.937 413.776C352.592 419.275 353.189 413.84 353.193 427.681C353.194 433.536 353.976 437.949 351.662 442.539Z" fill="#ECC468" />
            <path fillRule="evenodd" clipRule="evenodd" d="M489.484 279.215L501.317 279.341C500.48 275.348 499.158 277.345 499.119 270.68L499.131 246.838C499.158 238.844 500.776 241.312 501.351 237.571L489.624 237.557C489.878 240.359 491.811 240.159 491.847 246.138L491.861 269.993C491.886 276.367 491.096 275.089 489.484 279.215Z" fill="#02ABAA" />
            <path fillRule="evenodd" clipRule="evenodd" d="M322.972 442.611L343.601 442.653L343.641 435.737C341.517 437.555 341.552 439.272 339.13 440.429C336.76 441.562 333.316 441.485 331.114 440.573C328.985 437.919 329.881 432.266 330.001 428.597C336.941 428.119 335.514 429.652 338.646 432.316L338.66 423.195C336.293 426.54 335.224 427.717 330.244 427.217L329.972 415.199C332.676 414.941 335.39 414.945 337.62 415.748C340.105 416.643 340.425 417.752 342.084 419.579C342.18 419.687 342.375 419.878 342.455 419.965C342.536 420.052 342.7 420.23 342.835 420.349L342.728 413.655L323.29 413.692C323.747 415.531 324.645 416.456 324.775 419.488C324.887 422.097 324.772 425.033 324.772 427.681C324.774 434.469 325.621 437.607 322.972 442.611Z" fill="#EAC578" />
            <path fillRule="evenodd" clipRule="evenodd" d="M383.001 442.573L391.479 442.531C388.921 439.097 389.613 426.412 389.746 420.164C389.806 417.394 390.834 415.517 390.903 413.673L383.29 413.683C383.911 419.051 384.568 413.799 384.557 427.681C384.552 433.772 385.311 437.709 383.001 442.573Z" fill="#ECC468" />
            <path fillRule="evenodd" clipRule="evenodd" d="M243.271 442.559L251.818 442.569C248.573 438.193 249.346 418.9 251.514 413.881L243.486 413.762C245.501 418.813 245.746 437.167 243.271 442.559Z" fill="#ECC468" />
            <path fillRule="evenodd" clipRule="evenodd" d="M411.07 418.649L411.411 420.862C413.012 424.388 414.944 428.601 416.2 432.429L417.011 434.009C417.631 436.408 420.191 439.703 417.35 442.287L427.256 442.669C423.18 435.093 425.008 440.16 420.163 428.631C418.017 423.523 415.707 418.282 413.796 413.302C412.217 414.316 411.171 415.325 411.07 418.649Z" fill="#ECC468" />
            <path fillRule="evenodd" clipRule="evenodd" d="M106.841 364.432C109.254 363.386 108.354 363.77 108.333 355.621L108.324 304.605C108.377 301.675 108.604 298.317 110.322 296.566C112.048 294.806 114.533 295.06 115.757 294.643L117.169 293.899C117.271 293.838 117.465 293.692 117.589 293.563L97.6465 293.494C100.219 295.756 102.423 294.366 104.667 296.593C108.155 300.055 106.829 317.952 106.829 324.35C106.83 337.711 106.832 351.071 106.841 364.432Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M267.02 476.537C269.103 475.87 272.531 475.746 275.025 476.76C275.108 482.154 266.315 483.229 267.02 476.537ZM272.029 470.009C267.11 471.05 267.18 466.346 268.834 462.979C273.779 462.919 273.265 466.304 272.029 470.009ZM267.335 470.381C264.981 474.323 266.581 472.18 265.973 475.291C265.651 476.946 263.505 478.313 264.647 480.34C269.313 484.902 279.672 480.663 276.785 474.365C275.483 472.834 272.578 473.606 270.479 473.276C268.333 472.938 269.773 473.47 268.219 472.548C269.599 470.048 267.505 471.959 271.046 471.096C274.777 470.187 277.842 468.722 274.658 463.031L275.348 462.966C277.752 462.518 277.184 462.855 277.737 461.672C274.874 457.993 276.515 461.924 271.563 462.011C262.565 462.168 263.851 468.819 267.335 470.381Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M221.888 439.969L222.027 439.845L220.993 437.245C220.872 436.52 220.953 434.641 220.976 433.796L221.339 414.733L217.134 414.55L217.079 441.346L222.636 441.612L221.888 439.969Z" fill="#F5C666" />
            <path fillRule="evenodd" clipRule="evenodd" d="M359.702 462.99C361.376 466.216 360.919 472.184 360.011 475.651L364.31 475.599C364.261 471.399 362.45 466.259 364.921 464.689C370.557 461.109 369.875 471.28 368.848 475.589L373.308 475.516C371.543 470.433 374.87 460.417 367.66 462.068C365.745 462.506 365.153 463.165 364.314 464.162L363.444 461.845L359.702 462.99Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M221.887 439.97L222.635 441.612L217.079 441.347L217.133 414.55L221.338 414.733L220.976 433.796C220.952 434.642 220.871 436.52 220.993 437.245L222.027 439.845L221.917 418.804C222.104 415.458 222.92 415.719 223.134 413.716L215.41 413.688C215.448 415.998 216.513 414.519 216.51 427.681C216.509 434.089 217.353 437.352 214.946 442.663L235.676 442.672L235.639 433.918C233.494 436.378 233.872 438.555 231.145 440.163C227.89 442.082 224.228 441.15 221.887 439.97Z" fill="#DCC594" />
            <path fillRule="evenodd" clipRule="evenodd" d="M253.18 467.641C254.087 461.5 258.061 460.317 258.996 467.194L253.18 467.641ZM261.952 472.776C257.073 473.763 254.421 476.104 253.038 468.472H261.931C261.718 464.191 260.855 462.045 256.74 461.878C253.105 461.73 250.589 464.078 250.035 467.213C248.562 475.562 256.844 479.342 261.952 472.776Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M305.902 467.671C305.876 464.265 306.812 462.473 310.398 463.289C311.595 465.327 311.294 464.614 311.474 467.204L305.902 467.671ZM314.546 472.673C309.6 474.35 306.307 475.062 305.7 468.449L314.388 468.457C314.111 458.329 303.637 461.016 302.592 467.235C301.072 476.281 310.098 478.713 314.546 472.673Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M394.395 467.644C394.325 463.726 395.11 462.934 398.991 462.949L399.957 467.194L394.395 467.644ZM402.845 472.668C397.909 474.764 394.959 474.663 394.133 468.449L402.84 468.452C402.584 458.199 392.224 461.099 391.105 467.18C389.466 476.093 398.747 478.99 402.845 472.668Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M417.011 434.008L416.2 432.429L406.548 432.422L411.411 420.862L411.07 418.648C408.822 420.967 404.22 433.603 402.203 437.409C400.524 440.574 399.685 440.384 398.101 442.484L406.181 442.658C401.154 432.273 409.073 433.863 417.011 434.008Z" fill="#E8C588" />
            <path fillRule="evenodd" clipRule="evenodd" d="M282.846 467.67C283.175 463.528 283.333 462.638 287.431 463.11C287.999 464.191 288.496 465.401 288.712 467.102L282.846 467.67ZM291.102 473.045C285.66 474.576 283.552 474.406 282.693 468.436L291.57 468.468C291.231 458.994 281.314 460.505 279.775 466.917C277.816 475.078 287.795 479.315 291.102 473.045Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M235.276 475.618L247.517 475.597L247.853 470.538C246.525 471.964 246.285 473.758 244.342 474.462C234.802 477.915 240.177 457.844 240.178 457.843L235.001 457.703C237.12 462.334 236.195 470.966 235.276 475.618Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M388.493 472.675C382.167 475.448 379.256 472.357 379.926 467.088C380.334 463.877 382.124 462.583 385.407 463.265C385.285 465.418 384.608 465.019 385.654 466.99C395.302 466.703 379.961 455.743 376.968 466.616C374.44 475.797 385.343 479.091 388.493 472.675Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M625.527 381.117C623.815 384.027 624.849 382.142 625.602 382.798L637.484 378.972C637.843 377.012 638.191 374.968 638.517 373.167C638.629 372.551 638.951 370.757 638.959 370.343L638.584 368.288C637.078 369.649 630.416 378.439 627.358 380.434C626.314 381.114 626.777 380.914 625.527 381.117Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M342.022 475.758C345.031 470.985 345.063 466.402 348.655 462.357L344.572 462.168C345.486 465.58 344.465 469.189 342.618 471.415C341.595 468.077 339.285 465.481 340.56 462.307L334.972 462.178C335.977 464.327 337.317 466.326 338.557 469.217C339.49 471.392 340.492 474.538 342.022 475.758Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M316.869 462.429L317.991 463.72C319.924 465.724 316.278 481.238 325.405 474.376C321.513 472.376 321.702 478.033 321.735 463.605L324.918 463.198C324.009 462.135 326.522 462.067 321.842 462.089C321.622 459.32 321.996 459.653 320.727 458.293C319.825 460.519 318.953 461.353 316.869 462.429Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M350.99 463.194C352.637 466.069 352.588 471.836 351.334 475.562L355.905 475.583C354.316 470.785 355.76 466.836 354.807 461.943L350.99 463.194Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M385.173 410.503C388.089 410.612 387.696 409.699 389.736 407.971C391.557 406.428 392.725 406.145 393.763 404.081L388.326 403.976L385.173 410.503Z" fill="#ECC468" />
            <path fillRule="evenodd" clipRule="evenodd" d="M351.688 456.869L351.639 459.499L354.534 460.245C354.642 459.886 355.545 460.186 355.439 458.279C355.315 455.999 354.843 457.009 354.505 456.625L351.688 456.869Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M216.626 142.841L252.651 163.959C260.037 168.477 282.269 183.41 285.555 188.523L261.885 173.794C253.563 168.733 246.243 164.669 237.744 159.835C228.481 154.565 194.183 138.967 184.402 136.886L216.147 154.841C213.87 157.671 210.569 159.215 208.382 161.993C217.097 164.573 251.151 178.076 256.044 182.197L223.824 172.341C215.939 170.092 196.117 164.941 188.212 165.462C196.34 172.043 209.436 176.883 221.263 180.307C227.808 182.203 234.279 183.799 240.556 185.559C243.588 186.409 257.648 191.34 258.493 191.408C254.043 191.522 243.29 188.774 238.324 187.743C231.419 186.309 224.714 185.058 217.684 183.853C199.627 180.758 190.436 181.403 183.339 194.999L197.889 196.658L197.242 201.21C217.448 203.221 225.661 198.776 258.827 204.792C267.907 206.438 276.806 208.552 285.332 210.944C289.865 212.217 307.693 218.861 310.628 218.506C315.998 217.858 316.634 212.348 321.616 216.884C325.584 220.497 328.571 218.445 333.55 216.643C369.508 203.628 402.045 200.178 439.814 201.773C438.758 198.805 438.186 199.063 436.978 196.71L454.206 194.738C453.833 193.484 444.077 185.19 442.509 184.048C436.535 179.697 431.228 181.422 423.896 183.031C411.054 185.847 397.189 188.344 384.547 190.739C388.525 189.568 394.483 186.882 399.645 185.328C405.511 183.564 410.687 182.286 416.594 180.481C429.674 176.484 436.411 173.069 446.307 166.539C438.214 163.629 390.475 180.137 380.476 182.574L403.054 172.413C407.155 170.791 410.915 169.405 414.936 167.949C417.557 167 425.672 164.599 427.332 163.235C424.894 160.43 421.944 159.656 421.699 154.793C426.989 151.403 454.071 138.868 456.274 136.3C454.791 134.983 456.24 134.956 453.137 135.918C445.573 138.262 405.935 156.605 400.241 159.453C375.109 172.02 369.387 178.014 349.693 189.688C359.348 180.342 370.632 172.719 383.041 164.704L420.203 142.841C417.5 141.079 416.466 141.312 413.544 138.831C406.305 132.683 403.668 137.396 391.863 146.294C383.104 152.897 374.084 159.718 365.919 166.68C351.784 178.731 342.952 186.929 330.417 199.917C316.608 214.223 321.425 214.798 306.959 199.556C303.265 195.664 299.29 191.656 295.295 188.09C291.245 184.476 287.421 180.601 283.119 177.088C281.099 175.44 278.895 173.367 276.958 171.671C271.621 167.001 237.634 139.622 231.417 136.165C227.684 134.09 225.827 136.263 223.331 138.028C221.283 139.477 218.421 141.121 216.626 142.841Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M304.257 105.751C291.742 107.822 288.891 99.5691 285.957 97.2301C286.12 108.658 290.653 117.872 295.846 124.994C298.745 128.97 306.079 136.409 309.943 139.49C312.794 141.764 312.94 141.74 317.308 141.294L317.312 0L308.914 28.9277C305.757 38.3565 302.627 47.1551 298.479 55.8996C295.403 62.3866 289.427 75.6957 288.813 83.6768C287.889 95.6622 293.192 104.611 304.257 105.751Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M322.1 141.471C328.085 141.472 328.606 140.799 334.78 134.932C344.291 125.897 354.071 111.824 353.438 96.6894C349.042 102.271 346.239 107.291 335.325 105.829C360.561 99.8039 348.962 72.7267 341.224 56.5974C330.398 34.0275 329.174 21.3772 322.449 0.297363L322.1 141.471Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M305.292 160.516C316.225 173.371 312.286 167.476 316.636 179.181L317.589 182.277C318.048 183.769 317.993 184.265 318.602 185.004L318.543 166.589L318.6 163.147C318.6 163.139 318.458 163.107 318.347 163.061C318.065 162.946 317.658 162.781 317.31 162.399C316.799 161.837 316.585 161.55 316.477 160.966C316.164 159.278 316.675 158.146 318.177 157.507C318.555 157.346 318.828 157.193 319.562 157.209C320.151 157.222 320.711 157.427 321.224 157.736C321.573 157.933 321.798 158.222 322.036 158.513C322.737 159.324 322.637 160.641 322.466 161.12C322.235 162.065 321.462 162.782 320.882 163.15L320.895 166.672L320.902 185.004C322.68 180.64 323.666 175.995 325.755 171.511C328.678 165.237 331.373 164.595 334.074 160.516C330.988 156.196 326.195 155.254 326.203 146.41L313.256 146.221C313.048 154.607 309.157 156.268 305.292 160.516Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M289.417 140.608C289.535 136.806 257.932 60.3707 251.019 45.9696C248.062 39.808 246.265 32.0776 243.111 35.2676C241.232 37.1678 251.843 58.7329 253.303 62.0259C260.994 79.3744 281.882 132.27 289.417 140.608Z" fill="#ECC468" />
            <path fillRule="evenodd" clipRule="evenodd" d="M346.195 141.694C350.39 138.946 367.96 97.4584 371.424 89.9061C375.447 81.1325 379.135 72.2064 382.97 63.323C385.072 58.4572 394.513 40.0268 393.392 36.0355C388.943 35.9761 389.018 39.1565 385.42 47.4585L368.135 87.3248C363.426 98.8209 347.885 132.105 346.195 141.694Z" fill="#ECC468" />
            <path fillRule="evenodd" clipRule="evenodd" d="M275.682 147.962L207.449 60.8571C205.79 58.6343 205.133 55.8435 201.63 55.8867C199.964 59.5103 202.078 59.2067 204.08 62.1376C216.932 80.9543 240.524 108.775 255.22 126.75C261.312 134.2 273.646 145.384 275.682 147.962Z" fill="#ECC468" />
            <path fillRule="evenodd" clipRule="evenodd" d="M364.54 144.113C368.478 141.062 379.419 127.796 383.312 123.499C387.984 118.342 432.513 62.4186 435.139 56.5052L433.221 54.6914C430.384 57.024 426.932 62.2252 424.518 65.3672C417.754 74.1759 366.618 140.144 364.54 144.113Z" fill="#ECC468" />
            <path fillRule="evenodd" clipRule="evenodd" d="M192.462 105.569C201.55 108.077 203.868 113.788 206.982 118.479C209.482 111.492 214.266 107.622 221.505 105.437C212.606 99.399 214.231 105.141 206.834 90.6367C203.641 97.1443 203.776 99.3687 197.542 102.784L192.462 105.569Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M417.604 104.772C417.745 104.87 417.975 104.831 418.045 105.043L421.648 106.949C426.907 109.87 427.271 112.468 430.903 117.417C432.113 114.145 432.872 111.42 434.714 109.505C436.85 107.28 439.493 106.872 442.058 104.772C438.701 102.469 437.212 103.315 434.433 99.6495C432.816 97.5176 431.249 94.0305 429.307 92.0039C428.343 101.984 424.288 100.777 417.604 104.772Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M368.598 124.018C372.93 119.434 382.458 104.012 387.333 96.9328C389.062 94.4238 393.214 90.0776 392.218 86.7124C387.982 84.7173 389.045 87.1605 385.191 93.432C380.403 101.224 370.089 116.144 368.598 124.018Z" fill="#242424" />
            <path fillRule="evenodd" clipRule="evenodd" d="M267.443 124.355C266.239 118.522 260.785 109.29 257.931 104.32L249.721 90.1041C248.867 88.3625 247.676 84.7963 244.983 87.5172C242.855 89.6681 248.029 94.9561 249.432 97.1434L267.443 124.355Z" fill="#242424" />
            <path d="M319.493 163.274C321.207 163.274 322.597 161.919 322.597 160.248C322.597 158.577 321.207 157.222 319.493 157.222C317.779 157.222 316.39 158.577 316.39 160.248C316.39 161.919 317.779 163.274 319.493 163.274Z" fill="#242424" stroke="#242424" strokeWidth="0.288" strokeMiterlimit="22.9256" />
          </svg>
          <span className="font-bold text-xl tracking-tight text-slate-900">El Colegio Invisible</span>
        </div>
        <Button variant="ghost" size="icon" className="md:hidden" onClick={() => setIsOpen(false)}>
          <X className="h-5 w-5" />
        </Button>
      </div>

      <div className="flex-1 overflow-y-auto py-6 px-3 space-y-6" key={user?.email || 'guest'}>
        {menuGroups.map((group) => {
          // Check if user has permission for AT LEAST one item in group
          const hasGroupPermission = group.items.some(item =>
            isAdmin || permissions.includes(item.permission) || item.permission === 'PROFILE'
          );
          if (!hasGroupPermission) return null;

          const isExpanded = expandedGroups[group.title];

          return (
            <div key={group.title}>
              <button
                onClick={() => toggleGroup(group.title)}
                className="flex items-center justify-between w-full px-3 mb-2 text-xs font-bold text-slate-400 uppercase tracking-wider hover:text-slate-600 transition-colors"
              >
                {group.title}
                {isExpanded ? <ChevronDown className="h-3 w-3" /> : <ChevronRight className="h-3 w-3" />}
              </button>

              {isExpanded && (
                <div className="space-y-1">
                  {group.items.map((link) => {
                    if (!isAdmin && !permissions.includes(link.permission) && link.permission !== 'PROFILE') return null;
                    const isActive = pathname === link.href;
                    return (
                      <Link
                        key={link.href}
                        href={link.href}
                        onClick={closeMobileMenu} // Close on mobile click
                        className={`flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-all ${isActive
                            ? "bg-blue-50 text-blue-700 shadow-sm"
                            : "text-slate-600 hover:bg-slate-50 hover:text-slate-900"
                          }`}
                      >
                        <link.icon className={`h-4 w-4 ${isActive ? "text-blue-600" : "text-slate-400"}`} />
                        {link.title}
                      </Link>
                    )
                  })}
                </div>
              )}
            </div>
          );
        })}
      </div>

      <div className="p-4 border-t border-slate-100 bg-slate-50">
        <div className="flex items-center gap-3 mb-3 px-2">
          <div className="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-700 font-bold">
                {userInitial}
            </div>
            <div className="overflow-hidden">
                <p className="text-sm font-medium text-slate-900 truncate">{userName}</p>
                <p className="text-xs text-slate-500 truncate">{userRole}</p>
          </div>
        </div>
        <Button
          variant="outline"
          className="w-full justify-start gap-2 text-red-600 hover:text-red-700 hover:bg-red-50 border-red-100"
          onClick={() => logout()}
        >
          <LogOut className="h-4 w-4" />
          Cerrar Sesión
        </Button>
      </div>
    </div>
  );

  return (
    <>
      {/* Mobile Hamburger Trigger (Only visible on small screens when not inside MainLayout which might hide it) 
          Actually MainLayout usually places SidebarNav next to content. 
          We need to ensure this trigger is visible. 
          Ideally MainLayout should have the trigger, but we can put it here fixed if MainLayout doesn't hide overhead.
      */}
      <div className="md:hidden fixed top-0 left-0 bg-white border-b border-slate-200 z-40 w-full p-4 flex items-center shadow-sm">
        <Button variant="ghost" size="icon" onClick={() => setIsOpen(true)}>
          <Menu className="h-6 w-6 text-slate-700" />
        </Button>
        <span className="ml-3 font-bold text-lg text-slate-800">El Colegio Invisible</span>
      </div>

      {/* Spacer for mobile header to prevent content overlap */}
      <div className="md:hidden h-16" />

      {/* Desktop Sidebar (Static) */}
      <div className="hidden md:block w-64 h-screen sticky top-0 bg-white border-r border-slate-200 shadow-sm z-30">
        <NavContent />
      </div>

      {/* Mobile Sidebar (Overlay) */}
      {isOpen && (
        <div className="fixed inset-0 z-50 flex md:hidden">
          {/* Backdrop */}
          <div
            className="fixed inset-0 bg-black/50 backdrop-blur-sm animate-in fade-in"
            onClick={closeMobileMenu}
          />
          {/* Drawer */}
          <div className="relative w-72 h-full bg-white shadow-xl flex flex-col animate-in slide-in-from-left duration-300">
            <NavContent />
          </div>
        </div>
      )}
    </>
  )
}
