generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---
enum PaymentMethod {
  EFECTIVO
  TARJETA_DEBITO
  TARJETA_CREDITO
  TRANSFERENCIA
  VALES
  TARJETA 
}

enum UserRole {
  ADMIN
  VENDEDOR
  CONTADOR
}

enum DiscountType {
  PORCENTAJE
  MONTO_FIJO
}

// --- USUARIOS Y SUCURSALES ---

model User {
  id         Int         @id @default(autoincrement())
  nombre     String
  email      String      @unique
  password   String
  rol        UserRole    @default(VENDEDOR)
  activo     Boolean     @default(true)
  sucursalId Int?        @map("sucursal_id")
  sucursal   Sucursal?   @relation(fields: [sucursalId], references: [id])
  permisos   String[]    @default([])
  sales      Sale[]
  apartados  Apartado[]
  cajas      CorteCaja[]
  expenses   Expense[]

  createdAt DateTime @default(now()) @map("created_at")

  @@map("users")
}

model Sucursal {
  id               Int          @id @default(autoincrement())
  nombre           String       @unique
  direccion        String?
  serieFacturacion String?
  
  // Relaciones con ambos inventarios
  inventarioLibros Inventario[]
  inventarioDulces InventarioDulce[]
  inventarioConsignacion InventarioConsignacion[]
  
  users            User[]
  apartados        Apartado[]
  sales            Sale[]
  expenses         Expense[]
  cajas            CorteCaja[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("sucursales")
}

// --- MODELO ORIGINAL: LIBROS ---

model Book {
  id              Int         @id @default(autoincrement())
  isbn            String?     @unique
  titulo          String
  autor           String
  
  precioVenta     Decimal     @map("precio") @db.Decimal(10, 2)
  precioCompra    Decimal     @default(0) @map("precio_compra") @db.Decimal(10, 2)
  tasaIva         Decimal     @default(0) @map("tasa_iva") @db.Decimal(5, 2)
  
  editorial       String?
  anioPublicacion Int?        @map("anio_publicacion")
  genero          String?
  coleccion       String?

  deletedAt       DateTime? @map("deleted_at")

  inventario  Inventario[]
  saleDetails SaleDetail[]
  apartadoItems ApartadoItem[]
  discounts   DiscountCampaign[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([deletedAt])
  @@index([titulo])
  @@index([isbn])
  @@map("books")
}

// --- NUEVO MODELO: DULCERÍA ---
// Específico para productos empaquetados o a granel
model Dulce {
  id            Int      @id @default(autoincrement())
  codigoBarras  String?  @unique @map("codigo_barras") // EAN/UPC
  nombre        String   // Ej. "Doritos Nacho"
  marca         String?  // Ej. "Sabritas"
  lineaProducto String?  // Ej. "Flaming Hot", "Clásico"
  peso          String?  // Ej. "50g", "2L"
  sabor         String?  // Ej. "Queso y Chile"
  
  precioVenta   Decimal  @map("precio") @db.Decimal(10, 2)
  precioCompra  Decimal  @default(0) @map("precio_compra") @db.Decimal(10, 2)
  tasaIva       Decimal  @default(0) @map("tasa_iva") @db.Decimal(5, 2) // IEPS suele ser 8%

  // Relaciones propias
  inventario  InventarioDulce[]
  saleDetails SaleDetail[]
  apartadoItems ApartadoItem[]
  discounts   DiscountCampaign[]
  deletedAt     DateTime? @map("deleted_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@index([deletedAt])
  @@index([nombre])
  @@index([codigoBarras])
  @@map("dulces")
}

// --- INVENTARIOS SEPARADOS ---

model Inventario {
  bookId     Int      @map("book_id")
  sucursalId Int      @map("sucursal_id")
  stock      Int      @default(0)
  minStock   Int      @default(5) @map("min_stock")
  ubicacion  String?  
  
  book     Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  sucursal Sucursal @relation(fields: [sucursalId], references: [id], onDelete: Cascade)

  @@id([bookId, sucursalId])
  @@map("inventario")
}

model InventarioDulce {
  dulceId    Int      @map("dulce_id")
  sucursalId Int      @map("sucursal_id")
  stock      Int      @default(0)
  minStock   Int      @default(10) @map("min_stock")
  ubicacion  String?  // Ej. "Refrigerador 1"
  
  dulce    Dulce    @relation(fields: [dulceId], references: [id], onDelete: Cascade)
  sucursal Sucursal @relation(fields: [sucursalId], references: [id], onDelete: Cascade)

  @@id([dulceId, sucursalId])
  @@map("inventario_dulces")
}
model Consignacion {
  id               Int      @id @default(autoincrement())
  nombre           String
  descripcion      String?
  proveedor        String?
  
  // Datos tipo Libro
  isbn            String?     @unique
  autor           String?
  editorial       String?
  anioPublicacion Int?        @map("anio_publicacion")
  genero          String?
  coleccion       String?

  precioVenta      Decimal  @map("precio_venta") @db.Decimal(10, 2)
  gananciaLibreria Decimal  @map("ganancia_libreria") @db.Decimal(10, 2)
  deletedAt        DateTime? @map("deleted_at")

  inventario       InventarioConsignacion[]
  saleDetails      SaleDetail[]
  
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("consignaciones")
}

model InventarioConsignacion {
  consignacionId Int      @map("consignacion_id")
  sucursalId     Int      @map("sucursal_id")
  stock          Int      @default(0)
  
  consignacion   Consignacion @relation(fields: [consignacionId], references: [id], onDelete: Cascade)
  sucursal       Sucursal     @relation(fields: [sucursalId], references: [id], onDelete: Cascade)

  @@id([consignacionId, sucursalId])
  @@map("inventario_consignaciones")
}
model Cliente {
  id        Int      @id @default(autoincrement())
  nombre    String
  email     String?  @unique
  telefono  String?
  direccion String?
  
  // Identificación
  codigoBarras String? @unique @map("codigo_barras")
  sku          String? @unique
  tipo         String  @default("GENERAL") // ESTUDIANTE, GENERAL, ETC.

  // Campos específicos de estudiante (opcionales)
  matricula     String? 
  semestre      String?
  grupo         String?
  turno         String? 

  visitas      Visita[]
  // No linking to Sale strictly yet to avoid migration issues with existing data
  // sales        Sale[] 

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([codigoBarras])
  @@index([nombre])
  @@map("clientes")
}

model Visita {
  id        Int      @id @default(autoincrement())
  clienteId Int      @map("cliente_id")
  fecha     DateTime @default(now())
  motivo    String?
  
  cliente   Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@index([clienteId])
  @@index([fecha])
  @@map("visitas")
}

// --- MARKETING ---

model DiscountCampaign {
  id             Int          @id @default(autoincrement())
  nombre         String
  codigoCupon    String?      @unique @map("codigo_cupon")
  tipo           DiscountType
  valor          Decimal      @db.Decimal(10, 2)
  activo         Boolean      @default(true)
  fechaInicio    DateTime     @map("fecha_inicio")
  fechaFin       DateTime     @map("fecha_fin")

  aplicarAGenero String? @map("aplicar_a_genero")
  
  // Puede aplicar a un libro O a un dulce
  aplicarABookId Int?    @map("aplicar_a_book_id")
  book           Book?   @relation(fields: [aplicarABookId], references: [id])
  
  aplicarADulceId Int?   @map("aplicar_a_dulce_id")
  dulce           Dulce? @relation(fields: [aplicarADulceId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@map("discount_campaigns")
}

// --- VENTAS ---

model Sale {
  id         Int      @id @default(autoincrement())
  fecha      DateTime @default(now())
  sucursalId Int      @default(1) @map("sucursal_id")
  sucursal   Sucursal @relation(fields: [sucursalId], references: [id])
  userId     Int      @default(1) @map("user_id")
  user       User     @relation(fields: [userId], references: [id])
  clienteId  Int?     @map("cliente_id")

  subtotal       Decimal @default(0) @db.Decimal(10, 2)
  impuestos      Decimal @default(0) @db.Decimal(10, 2)
  descuentoTotal Decimal @default(0) @map("descuento_total") @db.Decimal(10, 2)
  montoTotal     Decimal @map("monto_total") @db.Decimal(10, 2)

  metodoPago PaymentMethod @default(EFECTIVO) @map("metodo_pago")
  estado     String        @default("COMPLETADA")

  requiereFactura Boolean  @default(false) @map("requiere_factura")
  datosFactura    Factura?
  details         SaleDetail[]

  createdAt DateTime @default(now()) @map("created_at")

  @@index([fecha])
  @@map("sales")
}

model SaleDetail {
  id                Int      @id @default(autoincrement())
  saleId            Int      @map("sale_id")
  cantidad_vendida  Int      @map("cantidad_vendida")
  created_at        DateTime @default(now()) @map("created_at")
  
  precioUnitario    Decimal @map("precio_unitario") @db.Decimal(10, 2)
  descuentoAplicado Decimal @default(0) @map("descuento") @db.Decimal(10, 2)
  impuestoAplicado  Decimal @default(0) @map("impuesto_aplicado") @db.Decimal(10, 2)
  subtotal          Decimal @db.Decimal(10, 2)

  // RELACIONES POLIMÓRFICAS (Opcionales, pero una debe existir)
  bookId Int?  @map("book_id")
  book   Book? @relation(fields: [bookId], references: [id])
  
  dulceId Int?   @map("dulce_id")
  dulce   Dulce? @relation(fields: [dulceId], references: [id])
  
  consignacionId Int? @map("consignacion_id")
  consignacion   Consignacion? @relation(fields: [consignacionId], references: [id])

  sale Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@map("sale_details")
}

// --- CAJA Y FACTURACIÓN ---

model CorteCaja {
  id            Int       @id @default(autoincrement())
  userId        Int       @map("user_id")
  sucursalId    Int       @map("sucursal_id")
  fechaApertura DateTime  @default(now()) @map("fecha_apertura")
  fechaCierre   DateTime? @map("fecha_cierre")
  montoInicial  Decimal   @map("monto_inicial") @db.Decimal(10, 2)
  ventasSistema Decimal   @default(0) @map("ventas_sistema") @db.Decimal(10, 2)
  gastosSistema Decimal   @default(0) @map("gastos_sistema") @db.Decimal(10, 2)
  montoFinal    Decimal?  @map("monto_final") @db.Decimal(10, 2)
  diferencia    Decimal?  @db.Decimal(10, 2)
  observaciones String?
  user          User      @relation(fields: [userId], references: [id])
  sucursal      Sucursal  @relation(fields: [sucursalId], references: [id])

  @@map("cortes_caja")
}

model Factura {
  id            Int     @id @default(autoincrement())
  saleId        Int     @unique @map("sale_id")
  rfc           String
  razonSocial   String  @map("razon_social")
  regimenFiscal String  @map("regimen_fiscal")
  usoCfdi       String  @map("uso_cfdi")
  uuid          String?
  xmlUrl        String?
  pdfUrl        String?
  sale          Sale    @relation(fields: [saleId], references: [id])

  @@map("facturas")
}

model busquedas_pendientes {
  id                   Int       @id @default(autoincrement())
  titulo               String    @db.VarChar(255)
  autor                String?   @db.VarChar(255)
  isbn                 String?   @db.VarChar(20)
  editorial            String?   @db.VarChar(255)
  genero               String?   @db.VarChar(100)
  descripcion          String?
  precio_estimado      Decimal?  @db.Decimal(10, 2)
  cliente_nombre       String    @db.VarChar(255)
  cliente_telefono     String    @db.VarChar(20)
  cliente_email        String?   @db.VarChar(255)
  cliente_notas        String?
  estado               String?   @default("pendiente") @db.VarChar(50)
  prioridad            String?   @default("media") @db.VarChar(20)
  fecha_solicitud      DateTime? @default(now()) @db.Timestamp(6)
  fecha_limite         DateTime? @db.Date
  fecha_actualizacion  DateTime? @default(now()) @db.Timestamp(6)
  notas_internas       String?
  precio_encontrado    Decimal?  @db.Decimal(10, 2)
  proveedor_encontrado String?   @db.VarChar(255)

  @@index([cliente_telefono], map: "idx_busquedas_cliente_telefono")
  @@index([estado], map: "idx_busquedas_estado")
  @@index([fecha_solicitud], map: "idx_busquedas_fecha_solicitud")
  @@index([prioridad], map: "idx_busquedas_prioridad")
}


// --- APARTADOS ---

enum ApartadoStatus {
  ACTIVO
  COMPLETADO
  CANCELADO
  VENCIDO
}

model Apartado {
  id              Int            @id @default(autoincrement())
  userId          Int            @map("user_id")
  sucursalId      Int            @map("sucursal_id")
  clienteNombre   String         @map("cliente_nombre")
  clienteTelefono String?        @map("cliente_telefono")
  fechaCreacion   DateTime       @default(now()) @map("fecha_creacion")
  fechaVencimiento DateTime      @map("fecha_vencimiento")
  estado          ApartadoStatus @default(ACTIVO)
  
  montoTotal      Decimal        @map("monto_total") @db.Decimal(10, 2)
  montoPagado     Decimal        @map("monto_pagado") @db.Decimal(10, 2)
  saldoPendiente  Decimal        @map("saldo_pendiente") @db.Decimal(10, 2)
  
  user            User           @relation(fields: [userId], references: [id])
  sucursal        Sucursal       @relation(fields: [sucursalId], references: [id])
  items           ApartadoItem[]

  @@map("apartados")
}

model ApartadoItem {
  id             Int      @id @default(autoincrement())
  apartadoId     Int      @map("apartado_id")
  bookId         Int?     @map("book_id")
  dulceId        Int?     @map("dulce_id")
  cantidad       Int
  precioUnitario Decimal  @map("precio_unitario") @db.Decimal(10, 2)
  subtotal       Decimal  @db.Decimal(10, 2)

  apartado       Apartado @relation(fields: [apartadoId], references: [id], onDelete: Cascade)
  book           Book?    @relation(fields: [bookId], references: [id])
  dulce          Dulce?   @relation(fields: [dulceId], references: [id])

  @@map("apartado_items")
}

// --- GASTOS ---
model Expense {
  id          Int      @id @default(autoincrement())
  monto       Decimal  @db.Decimal(10, 2)
  concepto    String
  categoria   String   // "LIMPIEZA", "PAPELERIA", "INSUMOS", "OTROS"
  fecha       DateTime @default(now())
  
  userId      Int      @map("user_id")
  user        User     @relation(fields: [userId], references: [id])
  
  sucursalId  Int      @map("sucursal_id")
  sucursal    Sucursal @relation(fields: [sucursalId], references: [id])

  createdAt   DateTime @default(now()) @map("created_at")
  
  @@map("expenses")
}

model Notification {
  id        Int      @id @default(autoincrement())
  type      String   // "GASTO", "STOCK_BAJO", etc.
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("notifications")
}