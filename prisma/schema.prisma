generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres"] // Útil para buscar libros por título
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---
enum PaymentMethod {
  EFECTIVO
  TARJETA_DEBITO
  TARJETA_CREDITO
  TRANSFERENCIA
  TARJETA
}

enum UserRole {
  ADMIN
  VENDEDOR
  CONTADOR
}

enum DiscountType {
  PORCENTAJE
  MONTO_FIJO
}

// --- USUARIOS Y SUCURSALES ---

model User {
  id         Int       @id @default(autoincrement())
  nombre     String
  email      String    @unique
  password   String
  rol        UserRole  @default(VENDEDOR)
  activo     Boolean   @default(true)
  sucursalId Int?      @map("sucursal_id")
  sucursal   Sucursal? @relation(fields: [sucursalId], references: [id])
  sales      Sale[]    // Relación: Ventas realizadas por este usuario
  cajas      CorteCaja[] // Relación: Cortes de caja de este usuario

  createdAt  DateTime  @default(now()) @map("created_at")
  @@map("users")
}

model Sucursal {
  id         Int          @id @default(autoincrement())
  nombre     String       @unique
  direccion  String?
  serieFacturacion String? // Ej: "SUC-A" para folios fiscales internos
  inventario Inventario[]
  users      User[]
  sales      Sale[]       // Relación: Ventas en esta sucursal

  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")
  @@map("sucursales")
}

// --- PRODUCTOS E INVENTARIO ---

model Book {
  id              Int       @id @default(autoincrement())
  isbn            String?   @unique // Debe ser único
  titulo          String
  autor           String
  precioVenta     Decimal   @map("precio") @db.Decimal(10, 2)
  precioCompra    Decimal   @default(0) @map("precio_compra") @db.Decimal(10, 2)
  
  // Contabilidad: Libros suelen ser IVA 0%, pero otros productos no.
  tasaIva         Decimal   @default(0) @map("tasa_iva") @db.Decimal(5, 2) 
  
  editorial       String?
  anioPublicacion Int?      @map("anio_publicacion")
  genero          String?
  coleccion       String?
  
  inventario      Inventario[]
  saleDetails     SaleDetail[]
  discounts       DiscountCampaign[] // Relación inversa para descuentos directos

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([titulo])
  @@index([isbn])
  @@map("books")
}

model Inventario {
  bookId     Int      @map("book_id")
  sucursalId Int      @map("sucursal_id")
  stock      Int      @default(0)
  minStock   Int      @default(5) @map("min_stock") // Alerta de reabastecimiento
  ubicacion  String?  // Ej: "Pasillo 4, Estante B"
  
  book       Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  sucursal   Sucursal @relation(fields: [sucursalId], references: [id], onDelete: Cascade)

  @@id([bookId, sucursalId])
  @@map("inventario")
}

// --- MARKETING Y DESCUENTOS ---

model DiscountCampaign {
  id             Int          @id @default(autoincrement())
  nombre         String       // "Descuento Verano", "Liquidación"
  codigoCupon    String?      @unique @map("codigo_cupon") // Opcional: Para aplicar manualmente
  tipo           DiscountType
  valor          Decimal      @db.Decimal(10, 2)
  activo         Boolean      @default(true)
  fechaInicio    DateTime     @map("fecha_inicio")
  fechaFin       DateTime     @map("fecha_fin")

  // Alcance del descuento
  aplicarAGenero String?      @map("aplicar_a_genero")
  aplicarABookId Int?         @map("aplicar_a_book_id")
  book           Book?        @relation(fields: [aplicarABookId], references: [id])

  createdAt      DateTime     @default(now()) @map("created_at")
  @@map("discount_campaigns")
}



// --- VENTAS Y CONTABILIDAD ---

model Sale {
  id          Int           @id @default(autoincrement())
  fecha       DateTime      @default(now())
  
  // Relaciones vitales agregadas
  sucursalId  Int           @map("sucursal_id") @default(3)
  sucursal    Sucursal      @relation(fields: [sucursalId], references: [id])
  userId      Int           @map("user_id") @default(1)
  user        User          @relation(fields: [userId], references: [id])
  clienteId   Int?          @map("cliente_id") // Opcional, para cliente registrado
  
  // Desglose financiero (Vital para el contador)
  subtotal    Decimal       @db.Decimal(10, 2) @default(0) // Suma sin impuestos
  impuestos   Decimal       @db.Decimal(10, 2) @default(0) // IVA total 
  descuentoTotal Decimal    @default(0) @map("descuento_total") @db.Decimal(10, 2)
  montoTotal  Decimal       @map("monto_total") @db.Decimal(10, 2) // Lo que paga el cliente

  metodoPago  PaymentMethod @default(EFECTIVO) @map("metodo_pago")
  estado      String        @default("COMPLETADA") // COMPLETADA, CANCELADA, PENDIENTE
  
  // Facturación
  requiereFactura Boolean   @default(false) @map("requiere_factura")
  datosFactura    Factura?

  details     SaleDetail[]
  
  createdAt   DateTime      @default(now()) @map("created_at")
  @@index([fecha])
  @@map("sales")
}

model SaleDetail {
  id              Int      @id @default(autoincrement())
  saleId          Int      @map("sale_id")
  bookId          Int      @map("book_id")
  
  cantidad_vendida Int      @map("cantidad_vendida")
  created_at     DateTime @default(now()) @map("created_at")
  precioUnitario  Decimal  @map("precio_unitario") @db.Decimal(10, 2)
  descuentoAplicado Decimal @default(0) @map("descuento") @db.Decimal(10, 2)
  impuestoAplicado Decimal @default(0) @map("impuesto_aplicado") @db.Decimal(10, 2) // El monto de IVA de este item
  subtotal        Decimal  @db.Decimal(10, 2) // (precio - descuento) * cantidad
  
  book            Book     @relation(fields: [bookId], references: [id])
  sale            Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@map("sale_details")
}

// --- NUEVO: CONTROL DE CAJA Y FACTURACIÓN ---

model CorteCaja {
  id            Int      @id @default(autoincrement())
  userId        Int      @map("user_id")
  sucursalId    Int      @map("sucursal_id")
  fechaApertura DateTime @default(now()) @map("fecha_apertura")
  fechaCierre   DateTime? @map("fecha_cierre")
  
  montoInicial  Decimal  @map("monto_inicial") @db.Decimal(10, 2) // Fondo de caja
  ventasSistema Decimal  @default(0) @map("ventas_sistema") @db.Decimal(10, 2) // Calculado
  montoFinal    Decimal? @map("monto_final") @db.Decimal(10, 2) // Lo que cuenta el cajero
  diferencia    Decimal? @db.Decimal(10, 2) // Sobrante o faltante
  
  observaciones String?

  user          User     @relation(fields: [userId], references: [id])
  @@map("cortes_caja")
}

model Factura {
  id          Int      @id @default(autoincrement())
  saleId      Int      @unique @map("sale_id")
  rfc         String
  razonSocial String   @map("razon_social")
  regimenFiscal String @map("regimen_fiscal") // Ej: "601"
  usoCfdi     String   @map("uso_cfdi")       // Ej: "G03"
  uuid        String?  // Folio fiscal del SAT una vez timbrada
  xmlUrl      String?  // Link al archivo XML
  pdfUrl      String?  // Link al archivo PDF
  
  sale        Sale     @relation(fields: [saleId], references: [id])
  @@map("facturas")
}

model busquedas_pendientes {
  id                   Int       @id @default(autoincrement())
  titulo               String    @db.VarChar(255)
  autor                String?   @db.VarChar(255)
  isbn                 String?   @db.VarChar(20)
  editorial            String?   @db.VarChar(255)
  genero               String?   @db.VarChar(100)
  descripcion          String?
  precio_estimado      Decimal?  @db.Decimal(10, 2)
  cliente_nombre       String    @db.VarChar(255)
  cliente_telefono     String    @db.VarChar(20)
  cliente_email        String?   @db.VarChar(255)
  cliente_notas        String?
  estado               String?   @default("pendiente") @db.VarChar(50)
  prioridad            String?   @default("media") @db.VarChar(20)
  fecha_solicitud      DateTime? @default(now()) @db.Timestamp(6)
  fecha_limite         DateTime? @db.Date
  fecha_actualizacion  DateTime? @default(now()) @db.Timestamp(6)
  notas_internas       String?
  precio_encontrado    Decimal?  @db.Decimal(10, 2)
  proveedor_encontrado String?   @db.VarChar(255)

  @@index([cliente_telefono], map: "idx_busquedas_cliente_telefono")
  @@index([estado], map: "idx_busquedas_estado")
  @@index([fecha_solicitud], map: "idx_busquedas_fecha_solicitud")
  @@index([prioridad], map: "idx_busquedas_prioridad")
}
